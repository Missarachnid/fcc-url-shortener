/*User Stories:
 1. I can pass a URL as a parameter and I will receive a shortened URL in the JSON response.
 2. If I pass an invalid URL that doesn't follow the valid http://www.example.com format, the JSON response will contain an error instead.
 3.  When I visit that shortened URL, it will redirect me to my original link.
*/

//uses express as an app framework
const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors'); 
const mongoose = require('mongoose');
const path = require('path');
const app = express();
const shortUrl = require('./models/shortUrl');




app.use(bodyParser.json());
app.use(cors());

app.use(express.static(path.join(__dirname, 'public')));

//connect to database
mongoose.connect(process.env.MONGODB_URI || 'mongodb://locahost/url-shorteners');

app.get('/new/:urlToShorten(*)', (req, res, next)=>{
    var urlToShorten = req.params.urlToShorten;
    
    var expression = /[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi;

    var regex = expression;
    if(regex.test(urlToShorten) === true){
        return "Works";
    }else{
        return "Fails";
    }
  
    
});


app.listen(process.env.PORT || 8080, function () {
   
  console.log("listening");
});



/*var alphabet = "123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ";
var base = alphabet.length;

function encode(num){
    var encoded = "";
    while(num){
        var remainder = num % base;
        num = Math.floor(num/base);
        encoded = alphabet[remainder].toString() + encoded;
    }
    return encoded;
}

function decode(str){
    var decoded = 0;
    while(str){
        var index = alphabet.indexOf(str[0]);
        var power = str.length -1;
        decoded += index * (Math.pow(base, power));
        str = str.substring(1);
    }
    return decoded;
}


var CounterSchema = Schema({
    _id: {type: String, required: true},
    seq: {type: Number, default: 0}
});

var counter = mongoose.model("counter", CounterSchema);

var urlSchema = new Schema({
    _id: {type: Number, index: true},
    long_url: String,
    created_at: Date
});

urlSchema.pre("save", function(next){
    var doc = this;
    counter.findByIdAndUpdate({_id: "url_count"}, {$inc: {seq: 1}}, function(error, counter){
        if(error){
            return next(error);
        }
        doc._id = counter.seq;
        doc.created_at = new Date();
        next();
    });
});

var Url = mongoose.model("Url", urlSchema);

module.exports = Url;
module.exports.encode = encode;
module.exports.decode = decode;*/